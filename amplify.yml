version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
        - echo "üîç Environment Variables Debug:"
        - echo "All environment variables with OPENAI, VITE_, or REACT_APP_:"
        - env | grep -E "(OPENAI|VITE_|REACT_APP_)" || echo "No matching environment variables found"
        - echo "Specific checks:"
        - echo "VITE_OPENAI_API_KEY = $VITE_OPENAI_API_KEY"
        - echo "REACT_APP_OPENAI_API_KEY = $REACT_APP_OPENAI_API_KEY"
        - echo "OPENAI_API_KEY = $OPENAI_API_KEY"
    build:
      commands:
        - echo "üöÄ Starting build process..."
        - echo "Build-time environment check:"
        - 'echo "VITE_OPENAI_API_KEY length: ${#VITE_OPENAI_API_KEY}"'
        - 'echo "REACT_APP_OPENAI_API_KEY length: ${#REACT_APP_OPENAI_API_KEY}"'
        - 'echo "OPENAI_API_KEY length: ${#OPENAI_API_KEY}"'
        - npm run build
        - echo "‚úÖ Build completed successfully"
        - echo "üìÅ Checking dist directory:"
        - ls -la dist/
        - echo "üîç Checking built index.html for environment variable placeholders:"
        - grep -n "ENV_CONFIG\|VITE_OPENAI_API_KEY\|REACT_APP_OPENAI_API_KEY" dist/index.html || echo "No environment variable references found in HTML"
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
